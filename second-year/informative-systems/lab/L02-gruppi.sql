-- create tables

CREATE TABLE MODELLI (
	MODELLO VARCHAR(20) NOT NULL PRIMARY KEY,
	MARCA VARCHAR(20) NOT NULL,
	CILINDRATA INT NOT NULL CHECK (CILINDRATA > 0),
	ALIMENTAZIONE VARCHAR(10) NOT NULL,
	VELMAX INT NOT NULL CHECK (VELMAX > 0),
	PREZZOLISTINO DEC(8, 2) CHECK (PREZZOLISTINO > 0)
);

CREATE TABLE RIVENDITORI (
	CODR CHAR(5) NOT NULL PRIMARY KEY,
	CITTA VARCHAR(30) NOT NULL
);

CREATE TABLE AUTO (
	TARGA CHAR(7) NOT NULL PRIMARY KEY,
	MODELLO VARCHAR(20) NOT NULL REFERENCES MODELLI,
	CODR CHAR(5) NOT NULL REFERENCES RIVENDITORI,
	PREZZOVENDITA DEC(8, 2) NOT NULL CHECK (PREZZOVENDITA > 0),
	KM INT NOT NULL CHECK (KM >= 0),
	ANNO INT NOT NULL,
	VENDUTA CHAR(2) CHECK (VENDUTA = 'SI')
);

-- insert values

INSERT INTO RIVENDITORI
VALUES ('RIV01', 'Venezia'),
	('RIV02','Bologna'),
	('RIV03','Bologna'),
	('RIV04','Rimini');

INSERT INTO MODELLI
VALUES ('Agila', 'Opel', 998, 'Benzina', 180, 12000.00),
	('Aventador', 'Lamborghini', 6498, 'Benzina', 350, 432729.00),
	('Ghibli', 'Maserati', 3799, 'Benzina', 326, 150000.00),
	('Stratos', 'Lancia', 2419, 'Benzina', 230, 130000.00);

INSERT INTO AUTO
VALUES ('AG123AG', 'Agila', 'RIV03', 10500.00, 50000, 2003, NULL),
	('AG234AG', 'Agila', 'RIV03', 9000.00, 70000, 2003, NULL),
	('AV456AV', 'Aventador', 'RIV02',430000.00, 0, 2017, NULL),
	('AV567AV', 'Aventador', 'RIV02', 400000.00, 0, 2015, 'SI'),
	('GH789GH', 'Ghibli', 'RIV01', 90000.00, 0, 2015, 'SI'),
	('GH890GH', 'Ghibli', 'RIV02', 100000.00, 30000, 2013, NULL),
	('GH901GH', 'Ghibli','RIV03', 70000.00, 50000, 2015, 'SI'),
	('ST123ST', 'Stratos', 'RIV04', 80000.00, 15000, 1997, 'SI'),
	('ST234ST', 'Stratos','RIV04', 95000.00, 70000, 2012, 'SI');
	
-- select

-- Q1
SELECT m.*, a.*
FROM MODELLI m, AUTO a, RIVENDITORI r
WHERE m.MODELLO = a.MODELLO
	AND r.CODR = a.CODR
	AND m.MARCA = 'Maserati'
	AND r.CITTA = 'Bologna'
	AND a.PREZZOVENDITA < ((m.PREZZOLISTINO / 100.0) * 70);
	
-- Q2
SELECT AVG(a.PREZZOVENDITA) AS PREZZOAUTOBENZINA
FROM AUTO a, MODELLI m
WHERE a.MODELLO = m.MODELLO
	AND m.ALIMENTAZIONE = 'Benzina'
	AND m.CILINDRATA < 1000
	AND YEAR(CURRENT DATE) - a.ANNO >= 5
	AND a.KM < 80000;
	
-- Q3
SELECT a.MODELLO, MIN(a.PREZZOVENDITA) AS PREZZOMIN_BO
FROM AUTO a, MODELLI m, RIVENDITORI r
WHERE a.CODR = r.CODR
	AND a.MODELLO = m.MODELLO
	AND m.VELMAX > 180
	AND r.CITTA = 'Bologna'
GROUP BY a.MODELLO;
	
-- Q4
SELECT r.CITTA, COUNT(*) AS NUM_TRATTATE, COUNT(a.VENDUTA) AS NUM_VENDUTE
FROM AUTO a, RIVENDITORI r
WHERE a.CODR = r.CODR
GROUP BY r.CITTA;

-- Q5
SELECT r.CODR, r.CITTA
FROM AUTO a, RIVENDITORI r
WHERE a.CODR = r.CODR
GROUP BY r.CODR, r.CITTA
HAVING COUNT(a.VENDUTA) <= 0.8*COUNT(*)
ORDER BY r.CITTA, r.CODR;

-- Q6
SELECT a.CODR
FROM AUTO a
GROUP BY a.CODR, a.MODELLO
HAVING COUNT(a.VENDUTA) = 0
	
-- Q7
SELECT a.CODR, COUNT(a.VENDUTA) AS NUM_VENDUTE
FROM AUTO a
WHERE a.VENDUTA = 'SI'
GROUP BY a.CODR
HAVING AVG(a.PREZZOVENDITA) < 90000

-- Q8
SELECT a1.TARGA, COUNT(a2.TARGA) AS NUM_PREZZOMINORE
FROM AUTO a1 LEFT JOIN AUTO a2 ON
	(a1.PREZZOVENDITA > a2.PREZZOVENDITA)
	AND a2.VENDUTA = 'SI'
GROUP BY a1.TARGA;

-- Q9
SELECT a.ANNO, a.MODELLO, CAST(AVG(a.PREZZOVENDITA / m.PREZZOLISTINO) AS DECIMAL(8, 2)) AS AVG_RAPPORTO
FROM AUTO a, MODELLI m
WHERE a.MODELLO = m.MODELLO
GROUP BY a.ANNO, a.MODELLO
HAVING COUNT(a.VENDUTA) >= 2;

-- Q10
SELECT m.MODELLO, r.CODR
FROM MODELLI m CROSS JOIN RIVENDITORI r
EXCEPT
SELECT a.MODELLO, a.CODR
FROM AUTO a;
	
	