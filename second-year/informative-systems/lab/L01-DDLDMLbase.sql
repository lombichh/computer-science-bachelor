-- create tables

CREATE TABLE UTENTI (
	TESSERA INT NOT NULL PRIMARY KEY,
	NOME VARCHAR(25) NOT NULL,
	COGNOME VARCHAR(25) NOT NULL,
	TELEFONO VARCHAR(25) NOT NULL
)

CREATE TABLE LIBRI (
	CODICE INT NOT NULL PRIMARY KEY,
	TITOLO VARCHAR(25) NOT NULL,
	AUTORI VARCHAR(25) DEFAULT 'Anonimo',
	NOTE VARCHAR(300)
)

CREATE TABLE PRESTITI (
	CODICELIBRO INT NOT NULL REFERENCES LIBRI
		ON DELETE CASCADE,
	TESSERA INT NOT NULL REFERENCES UTENTI
		ON DELETE CASCADE,
	DATA_OUT DATE NOT NULL,
	DATA_IN DATE,
	PRIMARY KEY (CODICELIBRO, TESSERA, DATA_OUT),
	CHECK (DATA_OUT <= DATA_IN)
)

-- add data

INSERT INTO UTENTI
VALUES (1, 'Nome1', 'Cognome1', 'Telefono1'),
	(2, 'Nome2', 'Cognome2', 'Telefono2'),
	(3, 'Nome3', 'Cognome3', 'Telefono3'),
	(4, 'Nome4', 'Cognome4', 'Telefono4'),
	(5, 'Nome5', 'Cognome5', 'Telefono5'),
	(6, 'Nome6', 'Cognome6', 'Telefono6'),
	(7, 'Nome7', 'Cognome7', 'Telefono7'),
	(8, 'Nome8', 'Cognome8', 'Telefono8'),
	(9, 'Nome9', 'Cognome9', 'Telefono9'),
	(10, 'Nome10', 'Cognome10', 'Telefono10'),
	(11, 'Nome11', 'Cognome11', 'Telefono11'),
	(12, 'Nome12', 'Cognome12', 'Telefono12')
	
	
INSERT INTO LIBRI
VALUES (1, 'Titolo1', 'Autore1, Autore2', 'Bello'),
	(2, 'Titolo2', 'Autore2', 'Bello'),
	(4, 'Titolo4', 'Autore4', 'Brutto'),
	(7, 'Titolo7', 'Autore1', 'Bel libro')

INSERT INTO LIBRI(CODICE, TITOLO, NOTE)
VALUES (5, 'Titolo5', 'Bello')

INSERT INTO LIBRI(CODICE, TITOLO, AUTORI)
VALUES (3, 'Titolo3', 'Autore3'),
	(6, 'Titolo6', 'Autore5, Autore 1'),
	(8, 'Titolo8', 'Autore3')
	
	
INSERT INTO PRESTITI
VALUES (1, 1, '1.1.2000', '01.02.2000'),
	(1, 2, '2.1.2000', '5.2.2000'),
	(1, 3, '3.1.2000', '6.2.2000'),
	(2, 5, '4.1.2000', '7.2.2000'),
	(3, 4, '4.1.2000', '7.2.2000'),
	(1, 1, '5.1.2000', '8.2.2000'),
	(4, 7, '5.1.2000', '6.2.2000'),
	(5, 2, '6.1.2000', '8.2.2000')

INSERT INTO PRESTITI(CODICELIBRO, TESSERA, DATA_OUT)
VALUES (4, 1, '1.1.2000'),
	(6, 2, '2.1.2000'),
	(2, 3, '3.1.2000'),
	(5, 5, '4.1.2000'),
	(2, 4, '4.1.2000')

-- update

UPDATE UTENTI
SET TELEFONO = 'Telefono13'
WHERE TESSERA = 1

UPDATE LIBRI
SET NOTE = 'Non male'
WHERE CODICE = 6

UPDATE PRESTITI 
SET DATA_IN = '1.1.2001'
WHERE (CODICELIBRO, TESSERA, DATA_OUT) = (2, 4, '4.1.2000')

-- delete

DELETE UTENTI
WHERE TESSERA = 5

DELETE LIBRI
WHERE CODICE = 3

-- select

-- Q1
SELECT *
FROM LIBRI
WHERE AUTORI LIKE '%Autore1%' AND TITOLO = 'Titolo7'

-- Q2
SELECT *
FROM UTENTI
WHERE COGNOME = 'Cognome2'

-- Q3
SELECT *
FROM PRESTITI
WHERE YEAR(DATA_OUT) = 2000

-- Q4
SELECT *
FROM PRESTITI
WHERE NOT(YEAR(DATA_OUT) = YEAR(DATA_IN))

-- Q5
SELECT p.CODICELIBRO
FROM PRESTITI p, UTENTI u
WHERE u.TESSERA = p.TESSERA 
	AND u.NOME = 'Nome1' 
	AND u.COGNOME = 'Cognome1'
	AND u.TESSERA = 1

-- Q6
SELECT p.CODICELIBRO
FROM PRESTITI p, UTENTI u
WHERE u.TESSERA = p.TESSERA 
	AND u.NOME = 'Nome1' 
	AND u.COGNOME = 'Cognome1'
	AND u.TESSERA = 1
	AND p.DATA_OUT BETWEEN '2.1.2000' AND '5.1.2000'
	
-- Q7
SELECT l.*
FROM PRESTITI p, UTENTI u, LIBRI l
WHERE u.TESSERA = p.TESSERA 
	AND l.CODICE = p.CODICELIBRO
	AND u.NOME = 'Nome1' 
	AND u.COGNOME = 'Cognome1'
	AND u.TESSERA = 1
	AND p.DATA_OUT BETWEEN '2.1.2000' AND '5.1.2000'

-- Q8
SELECT DISTINCT u.TESSERA
FROM UTENTI u, PRESTITI p1, PRESTITI p2
WHERE u.TESSERA = p1.TESSERA
	AND u.TESSERA = p2.TESSERA
	AND NOT((p1.CODICELIBRO, p1.DATA_OUT) = (p2.CODICELIBRO, p2.DATA_OUT)) -- libri diversi
	AND YEAR(p1.DATA_OUT) = 2000
	AND YEAR(p2.DATA_OUT) = 2000

-- Q9
SELECT u.TESSERA
FROM UTENTI u LEFT JOIN PRESTITI p
	ON (u.TESSERA = p.TESSERA)
	AND YEAR(p.DATA_OUT) = 2000
WHERE p.CODICELIBRO IS NULL

-- Q10
SELECT u.TESSERA
FROM UTENTI u
EXCEPT
SELECT p.TESSERA 
FROM PRESTITI p, LIBRI l
WHERE p.CODICELIBRO = l.CODICE 
	AND l.AUTORI = 'Anonimo'
	AND l.NOTE = 'Bel libro'